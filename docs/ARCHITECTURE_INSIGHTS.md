# Honey Scan Architecture & Insights
*Documented on 2026-01-10*

## Core Components & Data Flow

### 1. HFish Sidecar (`sidecar/monitor.py`)
The sidecar is the central intelligence engine running on sensor nodes (`lemue-sec`, `lemue-sec-2`).

*   **Intelligence Loop (0.1s Interval):**
    *   Monitors `ipaddress` table for unsynced IPs (`pushed_to_bridge = 0`).
    *   **Dual Push Logic:** Pushes identified threats to **Multiple Targets** defined in `THREAT_BRIDGE_WEBHOOK_URL` (comma-separated).
        *   Target 1: `http://127.0.0.1:4444/webhook` (Local Loopback -> for local Dashboard visualization).
        *   Target 2: `https://api.sec.lemue.org/webhook` (Central Server -> for Global Intelligence).
    *   **Sync Status:** Once pushed, IPs are marked synced to prevent loops.

*   **Threat Feed Generation (`live_threats.json`):**
    *   Generates JSON for the Dashboard (`web/assets/live_threats.json`).
    *   **3-Way Bucket Strategy:** To prevent high-volume sources (Fail2Ban) from drowning out others, the SQL query uses a 3-way UNION with specific limits per refresh:
        1.  **Fail2Ban/Manual:** Limit 50 (Local Time).
        2.  **Honey Cloud (Bridge Sync):** Limit 50 (Local Time).
        3.  **Native (VNC/TCP/Portscan):** Limit 80 (UTC Time).
    *   **Total:** 180 entries max.
    *   **Frontend Binding:**
        *   `hackers` array -> "Recent active hackers" box.
        *   `cs` array -> "The recent suspicious CS" box.
        *   **CRITICAL:** `api_active: true` is REQUIRED in the JSON or the "suspicious CS" box (and possibly others) will be suppressed by the frontend, even if data is present.
        *   **Schema Requirements:** The `cs` objects share the same display component as `hackers` in some views, so fields like `flag` and `count` are necessary to prevent rendering errors, even if logically redundant for the "CS" view.

### 2. Timezone Strategy
The system handles a mix of Local Time and UTC data sources.

*   **Local Time Sources (Stored as `NOW()`):**
    *   `FAIL2BAN`: Generated by local script or API.
    *   `API_MANUAL`: Manually added via API.
    *   `BRIDGE_SYNC`: "Honey Cloud" Echo entries (generated by API receiving the local loopback push).
    *   *Handling:* Passed raw to JSON. Frontend displays as-is.

*   **UTC Sources (Stored as UTC):**
    *   `VNC`, `TCP`, `SSH`, (Native HFish services).
    *   *Handling:* The SQL query applies `DATE_ADD(..., INTERVAL 1 HOUR)` to normalize them to Local Time for correct sorting and display.

### 3. Client Script (`scripts/client_banned_ips.sh`)
Running on client machines to sync bans.

*   **Auto-Update:** Self-updates from GitHub main branch.
*   **Dynamic Jail Activation:**
    *   Scans open ports (`ss -tuln`) on startup.
    *   Automatically **Starts** relevant Fail2Ban jails (sshd, nginx, vsftpd, etc.).
    *   **Auto-Creation:** If a jail (e.g., `recidive`, `bedrock`) is missing, it dynamically writes config to `/etc/fail2ban/jail.d/honey-auto.conf` and reloads.
*   **Firewall Logic:** Uses `nftables` to enforce bans on specific ports associated with the jail.

## API Endpoints (`api/main.py`)
*   `POST /webhook`: Receives intelligence. Creates `BRIDGE_SYNC` entries in `infos` table.
*   `POST /api/v1/config/black_list/add`: Endpoint for `hfish-client.sh` and Fail2Ban actions. Treats input as `FAIL2BAN` service.

## Deployment Notes
*   **Dual Push Configuration:** Requires updating `.env` with comma-separated URLs and running `docker compose up -d` to apply changes (Restart is insufficient for Env updates).
*   **Sensor Nodes:** `lemue-sec` and `lemue-sec-2` act as independent sensors that feed the central `lemue-io`.
