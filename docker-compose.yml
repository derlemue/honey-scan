services:
  hfish:
    image: threatbook/hfish-server:latest
    container_name: hfish
    restart: unless-stopped
    network_mode: "host"
    dns:
      - 1.1.1.1
      - 1.0.0.1
    environment:
      - TZ=Europe/Amsterdam
    volumes:
      - hfish_data:/usr/share/hfish
      - ./config/hfish.toml:/usr/share/hfish/config.toml
      - ./web/index.html:/opt/hfish/current/web/index.html:ro
      - ./web/index.html:/opt/hfish/3.3.6/web/index.html:ro
      - ./web/login.html:/opt/hfish/current/web/login.html:ro
      - ./web/login.html:/opt/hfish/3.3.6/web/login.html:ro
      - ./web/login_native.html:/opt/hfish/current/web/login_native.html:ro
      - ./web/login_native.html:/opt/hfish/3.3.6/web/login_native.html:ro
      - ./web/assets/flags.svg:/opt/hfish/current/web/assets/flags.svg:ro
      - ./web/assets/flags.svg:/opt/hfish/3.3.6/web/assets/flags.svg:ro
      - ./web/assets/symbol-defs.svg:/opt/hfish/current/web/assets/symbol-defs.svg:ro
      - ./web/assets/symbol-defs.svg:/opt/hfish/3.3.6/web/assets/symbol-defs.svg:ro
      - ./web/assets/country_map.js:/opt/hfish/current/web/assets/country_map.js:ro
      - ./web/assets/country_map.js:/opt/hfish/3.3.6/web/assets/country_map.js:ro
      - ./web/assets/logo_bear.png:/opt/hfish/current/web/assets/logo_bear.png:ro
      - ./web/assets/logo_bear.png:/opt/hfish/3.3.6/web/assets/logo_bear.png:ro
      - ./web/assets/favicon.ico:/opt/hfish/current/web/assets/favicon.ico:ro
      - ./web/assets/favicon.ico:/opt/hfish/3.3.6/web/assets/favicon.ico:ro
      - ./web/assets/favicon-32x32.png:/opt/hfish/current/web/assets/favicon-32x32.png:ro
      - ./web/assets/favicon-32x32.png:/opt/hfish/3.3.6/web/assets/favicon-32x32.png:ro
      - ./web/assets/favicon-16x16.png:/opt/hfish/current/web/assets/favicon-16x16.png:ro
      - ./web/assets/favicon-16x16.png:/opt/hfish/3.3.6/web/assets/favicon-16x16.png:ro
      - ./web/assets/apple-touch-icon.png:/opt/hfish/current/web/assets/apple-touch-icon.png:ro
      - ./web/assets/apple-touch-icon.png:/opt/hfish/3.3.6/web/assets/apple-touch-icon.png:ro
      - ./web/assets/location.json:/opt/hfish/current/web/assets/location.json:ro
      - ./web/assets/location.json:/opt/hfish/current/web/assets/location.json:ro
      - ./web/assets/location.json:/opt/hfish/3.3.6/web/assets/location.json:ro
      - ./web/assets/live_threats.json:/opt/hfish/current/web/assets/live_threats.json
      - ./web/assets/live_threats.json:/opt/hfish/3.3.6/web/assets/live_threats.json
      - ./web/assets/stats.json:/opt/hfish/current/web/assets/stats.json
      - ./web/assets/stats.json:/opt/hfish/3.3.6/web/assets/stats.json
      - ./web/assets/app.6539b5af.js:/opt/hfish/current/web/assets/app.6539b5af.js:ro
      - ./web/assets/app.6539b5af.js:/opt/hfish/3.3.6/web/assets/app.6539b5af.js:ro
      - ./docs:/opt/hfish/current/web/docs:ro
      - ./docs:/opt/hfish/3.3.6/web/docs:ro
      - ./api:/opt/hfish/api:ro
    deploy:
      resources:
        limits:
          memory: 4G
    privileged: true
    depends_on:
      - mariadb

  mariadb:
    image: mariadb:10.6
    container_name: hfish-db
    restart: unless-stopped
    dns:
      - 1.1.1.1
      - 1.0.0.1
    environment:
      - TZ=Europe/Amsterdam
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
      - MYSQL_DATABASE=${DB_NAME}
      - MYSQL_USER=${DB_USER}
      - MYSQL_PASSWORD=${DB_PASSWORD}
      - MYSQL_TCP_PORT=3307
    volumes:
      - db_data:/var/lib/mysql
    ports:
      - "3307:3307"
    networks:
      - default

  sidecar:
    build: ./sidecar
    container_name: hfish-sidecar-v2
    restart: unless-stopped
    environment:
      - TZ=Europe/Amsterdam
      - DB_TYPE=${DB_TYPE:-mysql}
      - DB_HOST=mariadb
      - DB_PORT=3307
      - DB_USER=hfish
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_NAME=hfish
      - FORCE_RESCAN=true
    volumes:
      - ./scans:/app/scans
      - ./feed:/app/feed
      - ./web/assets:/app/assets
      - ./sidecar/monitor.py:/app/monitor.py
      - ./api:/app/api
    ports:
      - "4434:4434"
    command: >
      sh -c " pip install --no-cache-dir fastapi==0.115.0 uvicorn[standard]==0.32.0 mysql-connector-python==9.1.0 python-dotenv==1.0.1 && cd /app/api && nohup uvicorn main:app --host 0.0.0.0 --port 4434 --workers 2 > /tmp/api.log 2>&1 & cd /app && exec python monitor.py "
    networks:
      - default
    depends_on:
      - mariadb

  feed:
    image: php:8.2-apache
    container_name: hfish-feed
    restart: unless-stopped
    dns:
      - 1.1.1.1
      - 1.0.0.1
    environment:
      - TZ=Europe/Amsterdam
    ports:
      - "8888:80"
    volumes:
      - ./config/feed_apache.conf:/etc/apache2/sites-enabled/000-default.conf
      - ./feed:/var/www/html
      - ./scans:/var/www/html/scans:ro
      - ./web/assets:/var/www/html/assets:ro
      - ./scripts:/var/www/html/scripts:ro

  proxy:
    image: nginx:alpine
    container_name: hfish-proxy
    restart: unless-stopped
    dns:
      - 1.1.1.1
      - 1.0.0.1
    ports:
      - "4433:443"
    volumes:
      - ./config/proxy_ssl.conf:/etc/nginx/conf.d/default.conf
      - ./config/certs:/etc/nginx/certs:ro
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      - hfish
      - feed

volumes:
  hfish_data:
  db_data:
