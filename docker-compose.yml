services:
  hfish:
    image: threatbook/hfish-server:latest
    container_name: hfish
    restart: unless-stopped
    network_mode: "host"
    dns:
      - 1.1.1.1
      - 1.0.0.1
    environment:
      - TZ=Europe/Amsterdam
    volumes:
      - hfish_data:/usr/share/hfish
      - ./config/hfish.toml:/usr/share/hfish/config.toml
      - ./web/index.html:/opt/hfish/current/web/index.html:ro
      - ./web/index.html:/opt/hfish/3.3.6/web/index.html:ro
      - ./web/assets/flags.svg:/opt/hfish/current/web/assets/flags.svg:ro
      - ./web/assets/flags.svg:/opt/hfish/3.3.6/web/assets/flags.svg:ro
      - ./web/assets/logo_bear.png:/opt/hfish/current/web/assets/logo_bear.png:ro
      - ./web/assets/logo_bear.png:/opt/hfish/3.3.6/web/assets/logo_bear.png:ro
      - ./web/assets/favicon.ico:/opt/hfish/current/web/assets/favicon.ico:ro
      - ./web/assets/favicon.ico:/opt/hfish/3.3.6/web/assets/favicon.ico:ro
      - ./web/assets/favicon-32x32.png:/opt/hfish/current/web/assets/favicon-32x32.png:ro
      - ./web/assets/favicon-32x32.png:/opt/hfish/3.3.6/web/assets/favicon-32x32.png:ro
      - ./web/assets/favicon-16x16.png:/opt/hfish/current/web/assets/favicon-16x16.png:ro
      - ./web/assets/favicon-16x16.png:/opt/hfish/3.3.6/web/assets/favicon-16x16.png:ro
      - ./web/assets/apple-touch-icon.png:/opt/hfish/current/web/assets/apple-touch-icon.png:ro
      - ./web/assets/apple-touch-icon.png:/opt/hfish/3.3.6/web/assets/apple-touch-icon.png:ro
      - ./web/assets/location.json:/opt/hfish/current/web/assets/location.json:ro
      - ./web/assets/location.json:/opt/hfish/current/web/assets/location.json:ro
      - ./web/assets/location.json:/opt/hfish/3.3.6/web/assets/location.json:ro
      - ./web/assets/live_threats.json:/opt/hfish/current/web/assets/live_threats.json:ro
      - ./web/assets/live_threats.json:/opt/hfish/3.3.6/web/assets/live_threats.json:ro
      - ./web/assets/app.6539b5af.js:/opt/hfish/current/web/assets/app.6539b5af.js:ro
      - ./web/assets/app.6539b5af.js:/opt/hfish/3.3.6/web/assets/app.6539b5af.js:ro
    deploy:
      resources:
        limits:
          memory: 4G
    privileged: true
    extra_hosts:
      - "x.threatbook.cn:152.32.218.155"
    depends_on:
      - mariadb

  mariadb:
    image: mariadb:10.6
    container_name: hfish-db
    restart: unless-stopped
    dns:
      - 1.1.1.1
      - 1.0.0.1
    environment:
      - TZ=Europe/Amsterdam
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
      - MYSQL_DATABASE=${DB_NAME}
      - MYSQL_USER=${DB_USER}
      - MYSQL_PASSWORD=${DB_PASSWORD}
    volumes:
      - db_data:/var/lib/mysql
    ports:
      - "3307:3306"
    networks:
      - default

  sidecar:
    build: ./sidecar
    container_name: hfish-sidecar
    restart: unless-stopped
    dns:
      - 1.1.1.1
      - 1.0.0.1
    environment:
      - TZ=Europe/Amsterdam
      - DB_TYPE=${DB_TYPE:-mysql}
      - DB_HOST=${DB_HOST:-mariadb}
      - DB_PORT=${DB_PORT:-3306}
      - DB_USER=${DB_USER:-hfish}
      - DB_PASSWORD=${DB_PASSWORD:-hfish}
      - DB_NAME=${DB_NAME:-hfish}
      - THREATBOOK_API_KEY=${THREATBOOK_API_KEY}
      - THREATBOOK_API_BASE_URL=${THREATBOOK_API_BASE_URL}
    volumes:
      - ./scans:/app/scans
      - ./feed:/app/feed
      - ./web/assets:/app/assets
    depends_on:
      - hfish
      - mariadb

  feed:
    image: nginx:alpine
    container_name: hfish-feed
    restart: unless-stopped
    dns:
      - 1.1.1.1
      - 1.0.0.1
    environment:
      - TZ=Europe/Amsterdam
    ports:
      - "8888:80"
    volumes:
      - ./feed:/usr/share/nginx/html/feed:ro
      - ./scans:/usr/share/nginx/html/scans:ro
      - ./feed/index.html:/usr/share/nginx/html/index.html:ro
      - ./web/assets:/usr/share/nginx/html/assets:ro

volumes:
  hfish_data:
  db_data:
