<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>lemueIO SecMonitor - DEPLOYMENT TEST</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="description" content="" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <link rel="stylesheet" href="/assets/hfish-ui.1.2.12.css" />
    <style type="text/css">
        .main-loading-wrap {
            text-align: center;
            margin-top: 100px;
            color: rgba(17, 18, 34, 0.6);
            font-size: 12px;
        }

        .lds-dual-ring {
            display: inline-block;
            width: 30px;
            height: 30px;
            margin-bottom: 10px;
        }

        .lds-dual-ring:after {
            content: " ";
            display: block;
            width: 24px;
            height: 24px;
            margin: 8px;
            border-radius: 50%;
            border: 2px solid rgba(17, 18, 34, 0.8);
            border-color: rgba(17, 18, 34, 0.8) transparent rgba(17, 18, 34, 0.8) transparent;
            animation: lds-dual-ring 1.2s linear infinite;
            animation: lds-dual-ring 1.2s linear infinite;
        }

        @keyframes lds-dual-ring {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
    <script>
        // === CLOUD INTELLIGENCE FETCH INTERCEPTOR ===
        // This must run BEFORE React loads to intercept API calls
        // Intercepts HFish cloud intelligence API endpoints and returns our live_threats.json data
        (function () {
            console.log("[Cloud Intelligence] Installing fetch interceptor...");

            const originalFetch = window.fetch;
            let threatDataCache = null;
            let lastFetchTime = 0;

            // Helper: Translate Chinese location names to English
            const translateLocation = (loc) => {
                const map = {
                    '美国': 'United States', '加拿大': 'Canada', '中国': 'China', '俄罗斯': 'Russia',
                    '德国': 'Germany', '英国': 'United Kingdom', '法国': 'France', '荷兰': 'Netherlands',
                    '巴西': 'Brazil', '印度': 'India', '日本': 'Japan', '韩国': 'South Korea',
                    '阿根廷': 'Argentina', '新加坡': 'Singapore', '澳大利亚': 'Australia',
                    '越南': 'Vietnam', '泰国': 'Thailand', '印度尼西亚': 'Indonesia',
                    '台湾': 'Taiwan', '香港': 'Hong Kong', '乌克兰': 'Ukraine', '波兰': 'Poland',
                    '意大利': 'Italy', '西班牙': 'Spain', '瑞典': 'Sweden', '挪威': 'Norway',
                    '芬兰': 'Finland', '丹麦': 'Denmark', '瑞士': 'Switzerland', '奥地利': 'Austria',
                    '比利时': 'Belgium', '爱尔兰': 'Ireland', '墨西哥': 'Mexico', '土耳其': 'Turkey',
                    '伊朗': 'Iran', '以色列': 'Israel', '沙特阿拉伯': 'Saudi Arabia', '南非': 'South Africa'
                };
                return map[loc] || loc;
            };

            // Fetch and cache threat data
            const getThreatData = async () => {
                const now = Date.now();
                // Cache for 30 seconds
                if (threatDataCache && (now - lastFetchTime) < 30000) {
                    return threatDataCache;
                }

                try {
                    const response = await originalFetch('/assets/live_threats.json?t=' + Math.floor(now / 60000));
                    const data = await response.json();

                    // Transform data to match HFish format
                    const hackers = (data.hackers || []).map(h => ({
                        ip: h.ip,
                        location: translateLocation(h.location),
                        time: h.time,
                        country: translateLocation(h.location),
                        flag: h.flag
                    }));

                    const cs = (data.cs || []).map(c => ({
                        ip: c.ip,
                        location: translateLocation(c.location),
                        type: c.type || 'Scanner',
                        risk: c.risk || 'Medium',
                        time: c.time || 'Just now',
                        severity: c.risk || 'Medium'
                    }));

                    threatDataCache = { hackers, cs, api_active: data.api_active };
                    lastFetchTime = now;
                    console.log("[Cloud Intelligence] Loaded threat data:", threatDataCache);
                    return threatDataCache;
                } catch (e) {
                    console.error("[Cloud Intelligence] Failed to load threat data:", e);
                    return { hackers: [], cs: [], api_active: false };
                }
            };

            // Intercept fetch
            window.fetch = async function (...args) {
                const url = args[0];

                // LOG ALL REQUESTS for debugging
                if (typeof url === 'string' && url.includes('/api/')) {
                    console.log("[Cloud Intelligence] Fetch request detected:", url);
                }

                if (typeof url === 'string') {
                    // Intercept cloud intelligence API endpoints
                    if (url.includes('/api/web/latest_cs') || url.includes('latest_cs')) {
                        console.log("[Cloud Intelligence] ✅ Intercepted latest_cs request");
                        const data = await getThreatData();
                        return new Response(JSON.stringify({
                            response_code: 0,
                            data: data.cs,
                            verbose_msg: "Success"
                        }), {
                            status: 200,
                            headers: { 'Content-Type': 'application/json' }
                        });
                    }

                    if (url.includes('/api/web/hack_portrait') || url.includes('hack_portrait')) {
                        console.log("[Cloud Intelligence] ✅ Intercepted hack_portrait request");
                        const data = await getThreatData();
                        return new Response(JSON.stringify({
                            response_code: 0,
                            data: data.hackers,
                            verbose_msg: "Success"
                        }), {
                            status: 200,
                            headers: { 'Content-Type': 'application/json' }
                        });
                    }

                    // Also intercept any generic "cloud" or "community" endpoints
                    if (url.includes('/api/web/cloud') || url.includes('/api/web/community')) {
                        console.log("[Cloud Intelligence] ✅ Intercepted cloud/community request");
                        const data = await getThreatData();
                        return new Response(JSON.stringify({
                            response_code: 0,
                            data: {
                                hackers: data.hackers,
                                cs: data.cs,
                                daily: data.cs.length,
                                total: data.hackers.length
                            },
                            verbose_msg: "Success"
                        }), {
                            status: 200,
                            headers: { 'Content-Type': 'application/json' }
                        });
                    }
                }

                // Pass through all other requests
                return originalFetch(...args);
            };

            console.log("[Cloud Intelligence] Fetch interceptor installed successfully");
        })();
    </script>
    <style id="nativeLoginStyles">
        /* Native Login Page - Hidden by default, shown via JavaScript on /login route */
        #nativeLogin {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #0f172a;
            z-index: 99999;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            overflow-y: auto;
            flex-direction: column;
            justify-content: flex-start;
            /* Use margin: auto on child for safe centering */
        }

        #nativeLogin.active {
            display: flex;
        }

        #nativeLogin .native-link-bar {
            position: fixed;
            top: 0;
            right: 0;
            display: flex;
            gap: 15px;
            z-index: 100000;
            background: rgba(0, 0, 0, 0.4);
            padding: 8px 20px;
            border-bottom-left-radius: 15px;
            backdrop-filter: blur(5px);
        }

        #nativeLogin .native-link-bar a {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            opacity: 0.7;
            transition: all 0.2s;
            color: #4ade80;
            text-decoration: none;
        }

        #nativeLogin .native-link-bar a:hover {
            opacity: 1;
            transform: scale(1.1);
        }

        #nativeLogin .native-link-bar svg {
            width: 100%;
            height: 100%;
            fill: currentColor;
        }

        #nativeLogin .native-link-bar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
        }

        #nativeLogin .native-login-container {
            width: 100%;
            max-width: 420px;
            background: rgba(30, 41, 59, 0.5);
            border-radius: 12px;
            padding: 40px 35px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            margin: auto;
            /* Safe vertical centering */
            flex-shrink: 0;
        }

        #nativeLogin .native-logo-section {
            text-align: center;
            margin-bottom: 30px;
        }

        #nativeLogin .native-logo-section img {
            width: 80%;
            max-width: 200px;
            height: auto;
            margin-bottom: 20px;
        }

        #nativeLogin .native-brand-title {
            color: #4ade80;
            font-size: 32px;
            font-weight: 900;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }

        #nativeLogin .native-brand-subtitle {
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.8);
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 500;
            display: inline-block;
        }

        #nativeLogin .native-form-group {
            margin-bottom: 20px;
        }

        #nativeLogin .native-form-label {
            display: block;
            color: #94a3b8;
            font-size: 14px;
            margin-bottom: 8px;
            font-weight: 500;
        }

        #nativeLogin .native-form-input {
            width: 100%;
            padding: 12px 16px;
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(148, 163, 184, 0.2);
            border-radius: 8px;
            color: #e2e8f0;
            font-size: 14px;
            transition: all 0.2s;
        }

        #nativeLogin .native-form-input:focus {
            outline: none;
            border-color: #4ade80;
            background: rgba(15, 23, 42, 0.8);
        }

        #nativeLogin .native-captcha-container {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 20px;
        }

        #nativeLogin .native-captcha-display {
            flex: 1;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 8px;
            padding: 0;
            /* Removed padding to maximize image size */
            display: flex;
            align-items: center;
            justify-content: center;
            height: 50px;
            /* Fixed height to match button */
            overflow: hidden;
            cursor: pointer;
            transition: all 0.2s;
        }

        #nativeLogin .native-captcha-display:hover {
            background: rgba(255, 255, 255, 1);
            transform: scale(1.02);
        }

        #nativeLogin .native-captcha-svg {
            width: 100%;
            height: 50px;
        }

        #nativeLogin .native-captcha-refresh {
            width: 50px;
            height: 50px;
            background: rgba(74, 222, 128, 0.2);
            border: 1px solid #4ade80;
            border-radius: 8px;
            color: #4ade80;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        #nativeLogin .native-captcha-refresh:hover {
            background: rgba(74, 222, 128, 0.3);
            transform: rotate(180deg);
        }

        #nativeLogin .native-error-message {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #fca5a5;
            padding: 12px;
            border-radius: 8px;
            font-size: 14px;
            margin-bottom: 20px;
            display: none;
        }

        #nativeLogin .native-error-message.show {
            display: block;
        }

        #nativeLogin .native-login-button {
            width: 100%;
            padding: 14px;
            background-color: #4ade80;
            border: none;
            border-radius: 8px;
            color: #0f172a;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 10px;
        }

        #nativeLogin .native-login-button:hover {
            background-color: #22c55e;
            transform: translateY(-1px);
        }

        #nativeLogin .native-login-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        #nativeLogin .native-forgot-password {
            text-align: center;
            margin-top: 15px;
        }

        #nativeLogin .native-forgot-password a {
            color: #4ade80;
            text-decoration: none;
            font-size: 14px;
            transition: all 0.2s;
        }

        #nativeLogin .native-forgot-password a:hover {
            color: #22c55e;
            text-decoration: underline;
        }

        #nativeLogin .native-footer {
            position: relative;
            bottom: auto;
            margin-top: 20px;
            padding-bottom: 20px;
            width: 100%;
            text-align: center;
            color: rgba(255, 255, 255, 0.5);
            font-size: 12px;
            pointer-events: none;
            flex-shrink: 0;
        }

        #nativeLogin .native-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 20000;
            align-items: center;
            justify-content: center;
        }

        #nativeLogin .native-modal.show {
            display: flex;
        }

        #nativeLogin .native-modal-content {
            background: rgba(30, 41, 59, 0.95);
            border-radius: 12px;
            padding: 30px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }

        #nativeLogin .native-modal-title {
            color: #4ade80;
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 15px;
        }

        #nativeLogin .native-modal-text {
            color: #94a3b8;
            font-size: 14px;
            margin-bottom: 20px;
            line-height: 1.6;
        }

        #nativeLogin .native-modal-close {
            width: 100%;
            padding: 12px;
            background-color: #4ade80;
            border: none;
            border-radius: 8px;
            color: #0f172a;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }

        #nativeLogin .native-modal-close:hover {
            background-color: #22c55e;
        }

        /* Mobile Fixes for v4.1.1 */
        @media (max-height: 800px) {

            html,
            body {
                overflow-y: auto !important;
                height: auto !important;
            }

            #nativeLogin {
                position: relative !important;
                height: auto !important;
                min-height: 100vh;
                padding-bottom: 60px;
                /* Space for footer */
                overflow-y: visible !important;
                flex-direction: column !important;
                justify-content: flex-start !important;
                padding-top: 40px;
            }

            .native-login-container {
                margin: 0 auto 20px !important;
                transform: none !important;
                top: 0 !important;
                flex-shrink: 0;
            }

            /* Inherits global styles now */
        }
    </style>
    <!-- <link rel="stylesheet" href="/styles/index.css"> -->
    <script type="text/javascript">
        if (!('remove' in Element.prototype)) {
            Element.prototype.remove = function () {
                if (this.parentNode) {
                    this.parentNode.removeChild(this);
                }
            };
        }
    </script>
    <link rel="shortcut icon" href="/assets/favicon.ico">
</head>

<body>
    <!-- NATIVE LOGIN PAGE (Hidden by default, shown via JS on /login route) -->
    <div id="nativeLogin">
        <div class="native-link-bar">
            <a href="https://github.com/derlemue/honey-scan" title="GitHub" target="_blank">
                <svg viewBox="0 0 24 24">
                    <path
                        d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z" />
                </svg>
            </a>
            <a href="https://feed.sec.lemue.org/" title="Feed" target="_blank">
                <svg viewBox="0 0 24 24">
                    <path
                        d="M6.18 15.64a2.18 2.18 0 0 1 2.18 2.18C8.36 19 7.38 20 6.18 20C5 20 4 19 4 17.82a2.18 2.18 0 0 1 2.18-2.18M4 4.44A15.56 15.56 0 0 1 19.56 20h-2.83A12.73 12.73 0 0 0 4 7.27V4.44m0 5.66a9.9 9.9 0 0 1 9.9 9.9h-2.83A7.07 7.07 0 0 0 4 12.93V10.1z" />
                </svg>
            </a>
            <a href="https://feed.sec.lemue.org/feed/banned_ips.txt" title="Banned IPs" target="_blank">
                <svg viewBox="0 0 24 24">
                    <path
                        d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z" />
                </svg>
            </a>
            <a href="https://lemue.org" title="lemue.org" target="_blank">
                <img src="https://lemue.org/favicon.ico" alt="lemue.org" onerror="this.style.display='none'">
            </a>
        </div>
        <div class="native-login-container">
            <div class="native-logo-section">
                <img src="/assets/logo_bear.png" alt="Honey Scan Logo">
                <div class="native-brand-title">Honey Scan</div>
                <div class="native-brand-subtitle">Active Defense Platform</div>
            </div>
            <form id="nativeLoginForm">
                <div class="native-error-message" id="nativeErrorMessage"></div>
                <div class="native-form-group">
                    <label class="native-form-label" for="nativeUsername">Username</label>
                    <input type="text" id="nativeUsername" class="native-form-input" placeholder="Enter your username"
                        required autocomplete="username">
                </div>
                <div class="native-form-group">
                    <label class="native-form-label" for="nativePassword">Password</label>
                    <input type="password" id="nativePassword" class="native-form-input"
                        placeholder="Enter your password" required autocomplete="current-password">
                </div>
                <div class="native-form-group">
                    <label class="native-form-label" for="nativeCaptcha">Verification Code</label>
                    <div class="native-captcha-container">
                        <div class="native-captcha-display" id="nativeCaptchaDisplay" title="Click to refresh">
                            <img id="nativeCaptchaImg" src="" alt="Captcha"
                                style="width: 100%; height: 100%; object-fit: contain; display: block;">
                        </div>
                        <button type="button" class="native-captcha-refresh" id="nativeCaptchaRefresh"
                            title="Refresh captcha">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                                <path
                                    d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z" />
                            </svg>
                        </button>
                    </div>
                    <input type="text" id="nativeCaptcha" class="native-form-input" placeholder="Enter the code above"
                        required autocomplete="off" style="margin-top: 10px;">
                </div>
                <button type="submit" class="native-login-button" id="nativeLoginButton">Sign In</button>
                <div class="native-forgot-password">
                    <a href="#" id="nativeForgotPasswordLink">Forgot Password?</a>
                </div>
            </form>
        </div>
        <div class="native-footer">for you by lemue.org ♥️</div>
        <div class="native-modal" id="nativeForgotPasswordModal">
            <div class="native-modal-content">
                <div class="native-modal-title">Password Recovery</div>
                <div class="native-modal-text">
                    Please contact your system administrator to reset your password.<br><br>
                    For security reasons, password recovery must be handled through secure channels.
                </div>
                <button class="native-modal-close" id="nativeModalClose">Close</button>
            </div>
        </div>
    </div>


    <div id="app">
        <div class="main-loading-wrap">
            <div class="spinner-wrapper">
                <div class="lds-dual-ring"></div>
                <div class="spinner-txt">Loading...</div>
            </div>
        </div>
    </div>
    <script>
        __REACT_DEVTOOLS_GLOBAL_HOOK__ = parent.__REACT_DEVTOOLS_GLOBAL_HOOK__;
    </script>

    <script id="nativeLoginScript">
        // NATIVE LOGIN PAGE ACTIVATION - EXECUTED IMMEDIATELY
        (function () {
            try {
                // Check if we are on the login page
                const isLoginPage = location.pathname.includes('/login') || location.hash.includes('login') || location.href.includes('login');

                console.log("[NativeLogin] Check:", { url: location.href, isLoginPage });

                if (isLoginPage) {
                    // 1. Activate Native Login Interface
                    const nativeLogin = document.getElementById('nativeLogin');
                    if (nativeLogin) {
                        nativeLogin.classList.add('active');
                        nativeLogin.style.display = 'flex'; // FORCE visibility
                        console.log("[NativeLogin] Activated UI");
                    } else {
                        console.error("[NativeLogin] #nativeLogin element not found!");
                    }

                    // 2. Hide React App Container
                    const app = document.getElementById('app');
                    if (app) {
                        app.style.display = 'none';
                        // Keep content cleared to save memory and prevent background execution
                        app.innerHTML = '';
                    }

                    // 3. Captcha Logic (Server-Side)
                    const captchaImg = document.getElementById('nativeCaptchaImg');
                    const captchaInput = document.getElementById('nativeCaptcha');

                    window.fetchCaptcha = function () {
                        if (!captchaImg) return;

                        // Add rotation effect to refresh button
                        const refreshBtn = document.getElementById('nativeCaptchaRefresh');
                        if (refreshBtn) refreshBtn.style.transform = 'rotate(180deg)';
                        setTimeout(() => { if (refreshBtn) refreshBtn.style.transform = 'none'; }, 300);

                        fetch('/v1/captcha')
                            .then(response => response.json())
                            .then(data => {
                                if (data.response_code === 0 && data.data) {
                                    captchaImg.src = data.data;
                                    captchaInput.value = ''; // Clear input on refresh
                                } else {
                                    console.error("[NativeLogin] Captcha API error:", data);
                                }
                            })
                            .catch(err => {
                                console.error("[NativeLogin] Captcha Fetch Error:", err);
                                // Fallback or user notification could go here
                            });
                    };

                    // Initial Captcha Load
                    window.fetchCaptcha();

                    // refresh button handler
                    const refreshBtn = document.getElementById('nativeCaptchaRefresh');
                    const captchaDisplay = document.getElementById('nativeCaptchaDisplay');
                    if (refreshBtn) refreshBtn.onclick = window.fetchCaptcha;
                    if (captchaDisplay) captchaDisplay.onclick = window.fetchCaptcha;

                    // 4. Login Logic
                    const form = document.getElementById('nativeLoginForm');
                    if (form) {
                        form.onsubmit = function (e) {
                            e.preventDefault();

                            const username = document.getElementById('nativeUsername').value.trim();
                            const password = document.getElementById('nativePassword').value;
                            const captcha = document.getElementById('nativeCaptcha').value.trim();
                            const errorDiv = document.getElementById('nativeErrorMessage');
                            const loginBtn = document.getElementById('nativeLoginButton');

                            if (!username || !password || !captcha) return;

                            // Reset error
                            errorDiv.style.display = 'none';
                            errorDiv.textContent = '';

                            // Set loading state
                            loginBtn.disabled = true;
                            const originalBtnText = loginBtn.textContent;
                            loginBtn.textContent = 'Verifying...';

                            // Login Request
                            fetch('/v1/login', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                // Send all potential keys to be safe
                                body: JSON.stringify({
                                    account: username,
                                    username: username,
                                    password: password,
                                    verification_code: captcha,
                                    captcha: captcha
                                })
                            })
                                .then(async response => {
                                    const text = await response.text();
                                    let data;
                                    try {
                                        data = JSON.parse(text);
                                    } catch (e) {
                                        throw new Error("Invalid Server Response: " + text.substring(0, 50));
                                    }

                                    console.log("[NativeLogin] Response:", data);

                                    if (data.response_code === 0) {
                                        // Success! Redirect.
                                        // Sometimes token is in data.data.token, sometimes set via cookie.
                                        // HFish typically uses cookie (JSESSIONID/token).
                                        // We just redirect to dashboard.
                                        window.location.href = '/web/dashboard';
                                    } else {
                                        // Logic Error
                                        throw new Error(data.verbose_msg || data.msg || "Login Failed");
                                    }
                                })
                                .catch(error => {
                                    console.error("[NativeLogin] Error:", error);
                                    errorDiv.textContent = error.message;
                                    errorDiv.style.display = 'block';
                                    errorDiv.classList.add('show');

                                    // Reset button
                                    loginBtn.disabled = false;
                                    loginBtn.textContent = originalBtnText;

                                    // Refresh captcha on failure
                                    window.fetchCaptcha();
                                });
                        };
                    }

                    // 5. Modal Logic (Forgot Password)
                    const modal = document.getElementById('nativeForgotPasswordModal');
                    const link = document.getElementById('nativeForgotPasswordLink');
                    const close = document.getElementById('nativeModalClose');
                    if (modal && link && close) {
                        link.onclick = (e) => { e.preventDefault(); modal.classList.add('show'); };
                        close.onclick = () => { modal.classList.remove('show'); };
                        modal.onclick = (e) => { if (e.target === modal) modal.classList.remove('show'); };
                    }
                }
            } catch (err) {
                console.error("[NativeLogin] Critical Setup Error:", err);
                // Last resort fallback
                const nl = document.getElementById('nativeLogin');
                if (nl) nl.style.display = 'flex';
            }
        })();
    </script>

    <script type="text/javascript" defer src="/assets/flags/svgxuse.min.js"></script>
    <script type="text/javascript">
        // React Blocking Logic - Strict Mode
        (function () {
            // Only load React app if NOT in login page
            const isLogin = location.pathname.includes('/login') || location.hash.includes('login') || location.href.includes('login');

            if (!isLogin) {
                var s1 = document.createElement('script');
                s1.type = 'text/javascript';
                s1.src = '/assets/dllSelf.09a1636445d39f4f9ec3.js';
                document.body.appendChild(s1);

                var s2 = document.createElement('script');
                s2.type = 'text/javascript';
                s2.src = '/assets/app.6539b5af.js';
                document.body.appendChild(s2);
            } else {
                console.log("[NativeLogin] React App Blocked (Login Page)");
            }
        })();
    </script>
    <script>
        // === HoneyScan Smart Network Interceptor ===
        // Dynamically patches API responses to fix geolocation bugs without touching the bundle.
        (function () {
            try {
                console.log("[HoneyScan] Initializing Smart Interceptor...");

                // 1. Load Trusted Location (Side-Channel) with Fallback
                // We attempt to load from file, but default to Germany if it fails (fix for 404/USA bug)
                const locationPromise = (async () => {
                    const paths = ['./assets/location.json', '/web/assets/location.json', '/assets/location.json'];
                    for (const path of paths) {
                        try {
                            const r = await fetch(path + '?t=' + Date.now());
                            if (r.ok) {
                                const data = await r.json();
                                console.log("[HoneyScan] Location loaded from " + path, data);
                                return data;
                            }
                        } catch (e) { console.debug("Failed path: " + path); }
                    }
                    console.warn("[HoneyScan] Location load failed. Using Fallback (Germany).");
                    return {
                        "country": "Germany",
                        "country_code": "DE",
                        "city": "Falkenstein",
                        "lat": 50.4779,
                        "lng": 12.3713,
                        "query": "127.0.0.1"
                    };
                })();

                // 2. Helper: Patch JSON Data
                async function patchJsonData(json) {
                    const loc = await locationPromise;
                    if (!loc) return json;

                    let patched = false;

                    // Helper to update a single node object
                    const patchNode = (node) => {
                        // Check if this looks like a node (has IP or ID)
                        if (node.intranet_ip || node.id) {
                            // Ensure geo_data exists
                            if (!node.geo_data) node.geo_data = {};

                            // Force Update
                            node.geo_data.Country = loc.country;
                            node.geo_data.City = loc.city;
                            // Inject coordinates if the map uses them directly
                            node.geo_data.lat = loc.lat;
                            node.geo_data.lng = loc.lng || loc.lon;

                            // Some maps use 'value' array for coords: [lng, lat]
                            if (node.value && Array.isArray(node.value)) {
                                node.value = [loc.lng || loc.lon, loc.lat, ...node.value.slice(2)];
                            }

                            return true;
                        }
                        return false;
                    };

                    // Case A: Root Object is a Node or has geo_data
                    if (patchNode(json)) patched = true;

                    // Case B: Array of Nodes (e.g. /api/web/node/list)
                    if (Array.isArray(json)) {
                        json.forEach(item => {
                            if (patchNode(item)) patched = true;
                        });
                    }

                    // Case C: Nested Data (Common in paginated responses: { data: { list: [...] } })
                    if (json.data) {
                        if (Array.isArray(json.data)) {
                            json.data.forEach(item => { if (patchNode(item)) patched = true; });
                        } else if (json.data.list && Array.isArray(json.data.list)) {
                            json.data.list.forEach(item => { if (patchNode(item)) patched = true; });
                        }
                    }

                    if (patched) console.log("[HoneyScan] Hot-Patched API Response with Geolocation!");
                    return json;
                }

                // 3. Intercept Fetch
                const originalFetch = window.fetch;
                window.fetch = async function (...args) {
                    const url = args[0];
                    const response = await originalFetch(...args);

                    // Skip own requests
                    if (typeof url === 'string' && url.includes('location.json')) return response;

                    // Exclude Dashboard Lists (Attackers) to prevent corruption
                    if (typeof url === 'string' && (url.includes('hack_portrait') || url.includes('latest_cs'))) return response;

                    // Only process JSON
                    const contentType = response.headers.get("content-type");
                    if (contentType && contentType.includes("application/json")) {
                        try {
                            const clone = response.clone();
                            const data = await clone.json();

                            // Heuristic: Does it look like node data?
                            const str = JSON.stringify(data);
                            if (str.includes('intranet_ip') || str.includes('geo_data')) {
                                const patchedData = await patchJsonData(data);
                                return new Response(JSON.stringify(patchedData), {
                                    status: response.status,
                                    statusText: response.statusText,
                                    headers: response.headers
                                });
                            }
                        } catch (e) {
                            // ignore parse errors, return original
                        }
                    }
                    return response;
                };

                // 4. Intercept XMLHttpRequest (for Axios/Legacy)
                const XHR = XMLHttpRequest.prototype;
                const open = XHR.open;
                const send = XHR.send;

                XHR.open = function (method, url) {
                    this._url = url;
                    return open.apply(this, arguments);
                };

                XHR.send = function () {
                    this.addEventListener('load', async function () {
                        if (this._url && (this._url.includes('location.json') || this._url.includes('hack_portrait') || this._url.includes('latest_cs'))) return;

                        if (this.responseText && (this.responseText.includes('intranet_ip') || this.responseText.includes('geo_data'))) {
                            try {
                                const json = JSON.parse(this.responseText);
                                const patched = await patchJsonData(json);

                                // Override responseText property
                                Object.defineProperty(this, 'responseText', {
                                    get: () => JSON.stringify(patched),
                                    configurable: true
                                });
                                Object.defineProperty(this, 'response', {
                                    get: () => JSON.stringify(patched),
                                    configurable: true
                                });
                            } catch (e) { }
                        }
                    });
                    return send.apply(this, arguments);
                };

            } catch (e) {
                console.error("[HoneyScan] Interceptor Init Failed", e);
            }
        })();
    </script>
    <script>
        // Branding Configuration
        console.log("[HoneyScan] Patch Script v2.2 Loaded");
        const BRAND_TITLE = "Honey Scan Active Defense";
        const LOGO_PATH = '/assets/logo_bear.png';

        const patchBrandingAggressive = () => {
            // Global: Keep Title Consistent
            if (document.title !== "lemueIO SecMonitor") {
                document.title = "lemueIO SecMonitor";
            }

            // === UNIVERSAL TEXT REPLACEMENT (Runs everywhere) ===
            // This fixes "XX Company Threat Monitor" on the dashboard
            const replaceTextContent = (selector, target, replacement) => {
                try {
                    const elements = document.querySelectorAll(selector);
                    elements.forEach(el => {
                        // Safety: Check if innerText exists
                        if (!el.innerText) return;

                        // CRITICAL: Only replace text in LEAF nodes (no children) to avoid destroyed React/Vue bindings
                        // replacing innerHTML on a container (like #app or a parent div) kills the application.
                        if (el.children.length === 0 && el.innerText.includes(target) && !el.dataset.branded) {
                            el.innerText = el.innerText.replace(target, replacement);
                            el.dataset.branded = 'true';
                        }
                    });
                } catch (e) { console.error('Branding patch error:', e); }
            };

            // Specific HFish Dashboard Elements
            // Use specific tags instead of '*' to improve performance and safety
            const textTags = 'div, span, h1, h2, h3, h4, h5, p, li, a, td, th';
            replaceTextContent(textTags, 'XX Company Threat Monitor', 'lemueIO SecMonitor');
            replaceTextContent(textTags, 'HFish Attack Map', 'lemueIO SecMonitor');
            replaceTextContent(textTags, 'HFish Statistics', 'lemueIO Statistics');
            replaceTextContent(textTags, 'Live Threat Monitor', 'lemueIO Active Intelligence Feed');

            // Route Detection: Only apply aggressive layout changes on Login Page
            const isLogin = location.href.includes('/login') || location.hash.includes('login');

            if (isLogin) {
                // === LOGIN PAGE LOGIC ===

                // 1. Logo Replacement (Left Side - SVG Wrapper)
                const leftWrapper = document.querySelector('div[class*="left-wrapper"]');
                if (leftWrapper) {
                    const svgs = leftWrapper.querySelectorAll('svg');
                    svgs.forEach(svg => {
                        if (svg.innerHTML.includes('#hfish') || svg.innerHTML.includes('hfish')) {
                            const container = svg.parentElement;
                            if (container && !container.dataset.patched && !container.querySelector('input')) {
                                container.innerHTML = '';
                                const newLogo = document.createElement('img');
                                newLogo.src = LOGO_PATH;
                                newLogo.style.maxWidth = '100%';
                                newLogo.style.height = 'auto';
                                container.appendChild(newLogo);
                                container.dataset.patched = 'true';
                            }
                        }
                    });
                }

                // 2. Central Branding Replacement (SVG -> HTML)
                const rightWrapper = document.querySelector('div[class*="right-wrapper"]');
                if (rightWrapper) {
                    const brandSvgs = rightWrapper.querySelectorAll('svg');
                    brandSvgs.forEach(svg => {
                        if (svg.innerHTML.includes('hfish') || svg.getAttribute('class')?.includes('onefish-logo')) {
                            if (!svg.dataset.patched) {
                                const container = document.createElement('div');
                                container.style.textAlign = 'center';
                                container.style.marginBottom = '20px';
                                container.style.display = 'flex';
                                container.style.flexDirection = 'column';
                                container.style.alignItems = 'center';
                                container.style.justifyContent = 'center';

                                const title = document.createElement('div');
                                title.innerText = "Honey Scan";
                                title.style.color = "#4ade80";
                                title.style.fontSize = "36px";
                                title.style.fontWeight = "900";
                                title.style.fontFamily = "sans-serif";
                                title.style.letterSpacing = "1px";
                                title.style.marginBottom = "8px";
                                title.style.lineHeight = "1.2";

                                const pill = document.createElement('div');
                                pill.innerText = "Active Defense Platform";
                                pill.style.backgroundColor = "rgba(255, 255, 255, 0.1)";
                                pill.style.color = "rgba(255, 255, 255, 0.8)";
                                pill.style.padding = "4px 12px";
                                pill.style.borderRadius = "12px";
                                pill.style.fontSize = "14px";
                                pill.style.fontWeight = "500";
                                pill.style.display = "inline-block";

                                container.appendChild(title);
                                container.appendChild(pill);

                                svg.replaceWith(container);
                                container.dataset.patched = 'true';
                            }
                        }
                    });
                }

                // 3. Inject "Nuclear" CSS for Login Only
                if (!document.getElementById('branding-style')) {
                    const style = document.createElement('style');
                    style.id = 'branding-style';
                    style.innerHTML = `
                      /* LOGIN PAGE ONLY STYLES */
                      html, body {
                          background-color: #0f172a !important; /* Cyber Dark */
                          margin: 0 !important;
                          padding: 0 !important;
                          overflow-x: hidden !important;
                      }

                      /* HIDE ORIGINAL HEADER ONLY */
                      div[class*="header"], header, .el-header, .header-wrapper, nav, section[class*="header"], 
                      .screen-header-left-title, .screen-title,
                      div[class*="top"], .el-card__header {
                          display: none !important;
                          opacity: 0 !important;
                          visibility: hidden !important;
                          height: 0 !important;
                          width: 0 !important;
                          padding: 0 !important;
                          margin: 0 !important;
                          border: none !important;
                          overflow: hidden !important;
                      }
                      
                      div[class*="header"] * { display: none !important; }

                      /* Fix Title Spacing */
                      div[class*="index-cssmodule__login-wrapper"], .login-container, .login-box {
                          margin-top: 10px !important; 
                      }
                      
                      /* Login Button Green */
                      div[class*="index-cssmodule__btn"], button[class*="index-cssmodule__btn"], .el-button--primary {
                          background-color: #4ade80 !important;
                          border-color: #4ade80 !important;
                          color: #0f172a !important; 
                          font-weight: bold !important;
                      }
                      div[class*="index-cssmodule__btn"]:hover, button[class*="index-cssmodule__btn"]:hover, .el-button--primary:hover {
                          background-color: #22c55e !important;
                          border-color: #22c55e !important;
                      }
                      
                      /* Footer IPv6 Button Green */
                      .index-cssmodule__ipv6-1nOCE {
                          background-color: #4ade80 !important;
                          color: #ffffff !important; 
                          font-weight: bold !important; 
                          border-color: #4ade80 !important; 
                          border: 1px solid #4ade80 !important;
                      }

                      /* Logo Padding For Clip Fix */
                      img[src*="logo_bear.png"] {
                          width: 80% !important; 
                          max-width: 350px !important;
                          display: block;
                          margin: 0 auto;
                          padding: 15px !important; 
                          box-sizing: border-box !important;
                          aspect-ratio: 1 / 1 !important; 
                          object-fit: contain !important; 
                          height: auto !important;
                      }
                      
                      /* Custom Footer - DISABLED
                      #lemue-footer {
                          position: fixed;
                          bottom: 10px;
                          width: 100%;
                          text-align: center;
                          color: rgba(255, 255, 255, 0.5);
                          font-size: 12px;
                          pointer-events: none;
                          z-index: 9999;
                      }
                      */

                      /* Top Right Link Bar - FLUSH TOP (0px) */
                      #lemue-link-bar {
                          position: fixed;
                          top: 0;
                          right: 0;
                          display: flex;
                          gap: 15px;
                          z-index: 10000;
                          background: rgba(0, 0, 0, 0.4);
                          padding: 8px 20px;
                          border-bottom-left-radius: 15px;
                          backdrop-filter: blur(5px);
                      }
                      .lemue-link {
                          display: flex;
                          align-items: center;
                          justify-content: center;
                          width: 24px;
                          height: 24px;
                          opacity: 0.7;
                          transition: opacity 0.2s;
                          color: #4ade80;
                      }
                      .lemue-link:hover {
                          opacity: 1;
                          transform: scale(1.1);
                          opacity: 1;
                      }
                      .lemue-link svg {
                          width: 100%;
                          height: 100%;
                          fill: currentColor;
                      }
                      .lemue-link img {
                          width: 100%;
                          height: 100%;
                          border-radius: 50%;
                      }
                    `;
                    document.head.appendChild(style);
                }

                // 4. Inject Footer - DISABLED (Duplicate Fix)
                /* 
                if (!document.getElementById('lemue-footer')) {
                    const footer = document.createElement('div');
                    footer.id = 'lemue-footer';
                    footer.innerHTML = 'for you by lemue.org ♥️';
                    document.body.appendChild(footer);
                }
                */

                // 5. Inject Link Bar
                if (!document.getElementById('lemue-link-bar')) {
                    const linkBar = document.createElement('div');
                    linkBar.id = 'lemue-link-bar';

                    const links = [
                        {
                            href: 'https://github.com/derlemue/honey-scan',
                            icon: '<svg viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg>',
                            title: 'GitHub'
                        },
                        {
                            href: 'https://feed.sec.lemue.org/',
                            icon: '<svg viewBox="0 0 24 24"><path d="M6.18 15.64a2.18 2.18 0 0 1 2.18 2.18C8.36 19 7.38 20 6.18 20C5 20 4 19 4 17.82a2.18 2.18 0 0 1 2.18-2.18M4 4.44A15.56 15.56 0 0 1 19.56 20h-2.83A12.73 12.73 0 0 0 4 7.27V4.44m0 5.66a9.9 9.9 0 0 1 9.9 9.9h-2.83A7.07 7.07 0 0 0 4 12.93V10.1z"/></svg>',
                            title: 'Feed'
                        },
                        {
                            href: 'https://feed.sec.lemue.org/feed/banned_ips.txt',
                            icon: '<svg viewBox="0 0 24 24"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/></svg>',
                            title: 'Banned IPs'
                        },
                        {
                            href: 'https://lemue.org',
                            icon: '<img src="https://lemue.org/favicon.ico" alt="lemue.org" onerror="this.style.display=\'none\'">',
                            title: 'lemue.org'
                        }
                    ];

                    links.forEach(link => {
                        const a = document.createElement('a');
                        a.href = link.href;
                        a.className = 'lemue-link';
                        a.target = '_blank';
                        a.innerHTML = link.icon;
                        a.title = link.title;
                        linkBar.appendChild(a);
                    });

                    document.body.appendChild(linkBar);
                }

            } else {
                // === DASHBOARD / OTHER PAGES LOGIC ===

                // Restore UI parts if needed
                const style = document.getElementById('branding-style');
                if (style) style.remove();

                const linkBar = document.getElementById('lemue-link-bar');
                if (linkBar) linkBar.remove();

                const footer = document.getElementById('lemue-footer');
                if (footer) footer.remove();
            }

            // Always Inject Favicons (Safe to check continuously)
            const addFavicon = (rel, href, sizes) => {
                if (!document.querySelector(`link[href="${href}"]`)) {
                    let link = document.createElement('link');
                    link.rel = rel;
                    link.href = href;
                    if (sizes) link.sizes = sizes;
                    document.head.appendChild(link);
                }
            };
            // Only clean up defaults once really
            if (!window.faviconsPatched) {
                document.querySelectorAll('link[rel="shortcut icon"]').forEach(e => e.remove());
                window.faviconsPatched = true;
            }

            addFavicon('icon', '/assets/favicon.ico');
            addFavicon('icon', '/assets/favicon-32x32.png', '32x32');
            addFavicon('icon', '/assets/favicon-16x16.png', '16x16');
            addFavicon('apple-touch-icon', '/assets/apple-touch-icon.png');
        };

        // === UNIFIED PATCH LOOP (Performance Optimization) ===
        // Runs all patches in a single loop to reduce browser overhead
        const runPatches = () => {
            patchBrandingAggressive();
            // patchDataIssues(); // DISABLED FOR DEBUGGING
            // fixLayoutAndFlags(); // DISABLED FOR DEBUGGING
            // injectCloudIntelligence(); 
        };

        // Start Loop (250ms is a good balance)
        setInterval(runPatches, 250);

        // === DATA PATCHING (Timezone & Flags) ===
        const patchDataIssues = () => {
            try {
                // 1. TIMEZONE FIX (+1 Hour for CET Correction)
                const timeElements = document.querySelectorAll('p[class*="time"], span[class*="time"]');
                timeElements.forEach(el => {
                    if (el.dataset.timePatched) return;
                    // ... (Timezone logic remains valid, omitted for brevity if unchanged, but included here for completeness) ...
                    const text = el.innerText.trim();
                    if (/^\d{4}\/\d{2}\/\d{2} \d{2}:\d{2}:\d{2}$/.test(text)) {
                        const dateStr = text.replace(/\//g, '-');
                        let date = new Date(dateStr);
                        if (!isNaN(date.getTime())) {
                            date.setTime(date.getTime() + 3600000); // +1 Hour
                            const pad = (n) => n.toString().padStart(2, '0');
                            const newText = `${date.getFullYear()}/${pad(date.getMonth() + 1)}/${pad(date.getDate())} ${pad(date.getHours())}:${pad(date.getMinutes())}:${pad(date.getSeconds())}`;
                            el.innerText = newText;
                            el.dataset.timePatched = 'true';
                        }
                    }
                });

                // 2. FLAG FIX (Map Name -> SVG Class)
                const flagSvgs = document.querySelectorAll('svg.flag-icon');
                flagSvgs.forEach(svg => {
                    if (svg.dataset.flagPatched) return; // IDEMPOTENCY CHECK

                    const useHref = svg.querySelector('use');
                    if (!useHref) return;

                    const href = useHref.getAttribute('xlink:href') || useHref.getAttribute('href');
                    if (!href || !href.includes('flagdefault')) return;

                    const countrySpan = svg.nextElementSibling;
                    if (!countrySpan || countrySpan.tagName !== 'SPAN') return;

                    const country = countrySpan.innerText.trim();
                    const countryMap = {
                        'China': 'cn', 'United States': 'us', 'Germany': 'de', 'France': 'fr',
                        'Russia': 'ru', 'United Kingdom': 'gb', 'Netherlands': 'nl', 'Brazil': 'br',
                        'India': 'in', 'Canada': 'ca', 'Korea': 'kr', 'Japan': 'jp', 'Vietnam': 'vn',
                        'Italy': 'it', 'Spain': 'es', 'Australia': 'au', 'Taiwan': 'tw', 'Singapore': 'sg',
                        'Nigeria': 'ng', 'Sweden': 'se', 'Poland': 'pl', 'Iran': 'ir', 'Turkey': 'tr',
                        'Romania': 'ro', 'Ukraine': 'ua', 'Mexico': 'mx', 'Argentina': 'ar', 'Ireland': 'ie',
                        'Austria': 'at', 'Switzerland': 'ch', 'Belgium': 'be', 'Denmark': 'dk', 'Norway': 'no',
                        'Finland': 'fi', 'Portugal': 'pt', 'Greece': 'gr', 'Czech Republic': 'cz', 'Hungary': 'hu',
                        'Indonesia': 'id', 'Thailand': 'th', 'Malaysia': 'my', 'Philippines': 'ph', 'South Africa': 'za',
                        'Egypt': 'eg', 'Israel': 'il', 'Slovakia': 'sk', 'Bulgaria': 'bg', 'Saudi Arabia': 'sa',
                        'United Arab Emirates': 'ae', 'Colombia': 'co', 'Chile': 'cl', 'Peru': 'pe', 'Pakistan': 'pk',
                        'Bangladesh': 'bd', 'New Zealand': 'nz', 'Hong Kong': 'hk', 'Britain': 'gb', 'England': 'gb',
                        'Great Britain': 'gb'
                    };

                    const code = countryMap[country];
                    if (code) {
                        useHref.setAttribute('xlink:href', `#hfish-flag-${code}`);
                        svg.classList.remove('undefined');
                        svg.classList.add(`flag-icon-${code}`);
                        svg.dataset.flagPatched = 'true';
                    }
                });


                // 3. TICKER FLAG FIX (Bottom Scrolling Box)
                // SAFETY UPDATE: START
                // Only act on SVGs that are confirmed to be flags or have the specific 'flag-icon-margin' class AND look like flags.
                // The issue was we were removing 'fill' from EVERYTHING with flag-icon-margin, killing Cloud Intelligence icons.
                const tickerSvgs = document.querySelectorAll('svg.flag-icon-margin');
                tickerSvgs.forEach(svg => {
                    const use = svg.querySelector('use');
                    if (!use) return;

                    const href = use.getAttribute('xlink:href') || use.getAttribute('href');

                    // Strict Check: Only hack the fill if it's actually pointing to a flag or default flag
                    // Cloud Intelligence icons usually don't have 'flag' in their href
                    const isFlag = href && (href.includes('flag') || href.includes('icon-') || href.includes('default'));

                    if (isFlag) {
                        // Remove the monochromatic fill ONLY for flags
                        if (svg.getAttribute('fill')) svg.removeAttribute('fill');
                        if (svg.style.fill) svg.style.fill = '';

                        // Fix Broken Defaults in Ticker
                        if (href.includes('flagdefault')) {
                            const box = svg.closest('.ant-carousel-item') || svg.closest('div[style*="background"]');
                            if (box) {
                                // Re-use country map from above (scope issue, redefined here for safety or move to global)
                                const cMap = { 'China': 'cn', 'United States': 'us', 'Germany': 'de', 'Russia': 'ru', 'United Kingdom': 'gb', 'Netherlands': 'nl', 'France': 'fr' }; // Short list for speed, full list above is better but this is patch
                                const text = box.innerText;
                                const country = Object.keys(cMap).find(c => text.includes(c));
                                if (country) {
                                    const newHref = `/symbol-defs.svg#icon-${cMap[country]}`;
                                    use.setAttribute('xlink:href', newHref);
                                    use.setAttribute('href', newHref);
                                    svg.style.display = 'inline-block';
                                    if (!svg.getAttribute('width')) svg.setAttribute('width', '24');
                                    if (!svg.getAttribute('height')) svg.setAttribute('height', '18');
                                }
                            }
                        }
                    }
                });
                // SAFETY UPDATE: END

            } catch (e) { console.error('Data patch error:', e); }
        };

        // === LAYOUT & FLAG FIXES ===
        const fixLayoutAndFlags = () => {
            try {
                // 1. Sidebar Overlap Fix (Aggressive)
                const headers = document.querySelectorAll('div, span, p, h3');
                for (let h of headers) {
                    if (h.innerText && h.innerText.trim() === 'Recent active hackers') {
                        let parent = h.parentElement;
                        let listContainer = null;
                        let maxChildren = 0;

                        const checkContainer = (container) => {
                            if (!container) return;
                            for (let child of container.children) {
                                if (child === h || child.contains(h)) continue;
                                if (child.children.length > maxChildren) {
                                    maxChildren = child.children.length;
                                    listContainer = child;
                                }
                            }
                        };

                        checkContainer(parent);
                        if (!listContainer && parent.parentElement) checkContainer(parent.parentElement);

                        if (listContainer && maxChildren > 2) {
                            if (listContainer.style.maxHeight !== '250px') {
                                listContainer.style.maxHeight = '250px';
                                listContainer.style.overflowY = 'auto';
                                listContainer.style.paddingRight = '5px';
                            }
                        }
                    }
                }

                // 2. Ticker Flag Fix (Robust External Reference)
                const svgs = document.querySelectorAll('svg');
                svgs.forEach(svg => {
                    const use = svg.querySelector('use');
                    if (use) {
                        const href = use.getAttribute('xlink:href') || use.getAttribute('href');
                        if (href && href.startsWith('#hfish-flag-')) {
                            const countryCode = href.replace('#hfish-flag-', '');
                            const newHref = `/symbol-defs.svg#icon-${countryCode}`;
                            use.setAttribute('xlink:href', newHref);
                            use.setAttribute('href', newHref);

                            // Only remove fill for these specific flags
                            if (svg.hasAttribute('fill')) svg.removeAttribute('fill');
                            if (svg.style.fill) svg.style.fill = '';

                            svg.style.display = 'inline-block';
                            if (!svg.getAttribute('width')) svg.setAttribute('width', '24');
                            if (!svg.getAttribute('height')) svg.setAttribute('height', '18');
                        }
                    }
                });

            } catch (e) { console.error("Layout/Flag Fix Error:", e); }
        };

        // === CLOUD THREAT INTELLIGENCE SYSTEM ===
        const HS_LOG_PREFIX = "[HoneyScan] ";
        const translateLocation = (loc) => {
            const map = {
                '美国': 'United States', '加拿大': 'Canada', '中国': 'China', '俄罗斯': 'Russia',
                '德国': 'Germany', '英国': 'United Kingdom', '法国': 'France', '荷兰': 'Netherlands'
            };
            return map[loc] || loc;
        };

        // 1. Data Fetcher
        window.getThreatData = async () => {
            try {
                const response = await fetch('/live_threats.json');
                if (!response.ok) throw new Error('Failed to fetch threat data');
                return await response.json();
            } catch (error) {
                console.error(HS_LOG_PREFIX + "Data Fetch Error:", error);
                // Fallback to local assets if root fails
                try {
                    const fallback = await fetch('/assets/live_threats.json');
                    return await fallback.json();
                } catch (e) { return null; }
            }
        };

        // 2. Dashboard Injector
        const injectDashboardThreats = async () => {
            try {
                const headers = Array.from(document.querySelectorAll('div, span, p, h3, h4'));
                const widgetHeader = headers.find(el => el.innerText && el.innerText.trim() === 'Threat Intelligence from the Cloud');
                if (!widgetHeader) return;

                let card = widgetHeader.closest('.el-card') || widgetHeader.closest('div[class*="card"]');
                if (!card) return;
                let body = card.querySelector('.el-card__body') || card.lastElementChild;
                if (!body || body.getAttribute('data-hs-injected') === 'true') return;

                const threats = (await window.getThreatData())?.cs || [];
                if (threats.length === 0) return;

                let rowHtml = threats.map(t => {
                    let c = '#4ade80'; if (t.risk === 'Medium') c = '#facc15'; if (t.risk === 'High') c = '#fb923c'; if (t.risk === 'Critical') c = '#ef4444';
                    return `
                        <tr style="border-bottom: 1px solid rgba(255,255,255,0.05);">
                            <td style="padding: 8px;"><div style="font-weight: bold; color: #e2e8f0; font-family: monospace;">${t.ip}</div></td>
                            <td style="padding: 8px; color: #94a3b8;">${translateLocation(t.location)}</td>
                            <td style="padding: 8px; color: #94a3b8;">${t.type || 'Scanner'}</td>
                            <td style="padding: 8px;"><span style="color:${c};background:${c}20;padding:2px 6px;border-radius:4px;font-size:11px;border:1px solid ${c}40;">${t.risk}</span></td>
                            <td style="padding: 8px; color: rgba(255,255,255,0.4);">${t.time}</td>
                        </tr>`;
                }).join('');

                body.innerHTML = `
                    <div style="width:100%; height:100%; overflow-y:auto; background: #1e293b; border-radius: 4px;">
                        <table style="width:100%; border-collapse:collapse; color:#fff; font-size:12px;">
                            <thead style="background: rgba(0,0,0,0.2); position: sticky; top: 0;">
                                <tr style="border-bottom:1px solid rgba(255,255,255,0.1);text-align:left;">
                                    <th style="padding:8px;">IP Address</th><th style="padding:8px;">Location</th>
                                    <th style="padding:8px;">Type</th><th style="padding:8px;">Risk</th><th style="padding:8px;">Time</th>
                                </tr>
                            </thead>
                            <tbody>${rowHtml}</tbody>
                        </table>
                    </div>`;
                body.setAttribute('data-hs-injected', 'true');
                console.log(HS_LOG_PREFIX + "Dashboard threat intelligence injected.");
            } catch (e) { console.error(HS_LOG_PREFIX + "Dashboard Error:", e); }
        };

        // === ROBUST LAYOUT SCALER ===
        // Injects CSS rules to force flex layout, persisting across React re-renders
        const ensureLayoutStyles = () => {
            if (document.getElementById('hs-layout-styles')) return;
            const style = document.createElement('style');
            style.id = 'hs-layout-styles';
            style.innerHTML = `
                /* V7 XPATH HUNTER STYLES */
                
                /* Target Discovered Column via ID */
                /* V9 FORCE OVERLAY STYLES */
                
                #hs-fixed-overlay {
                    position: fixed !important;
                    z-index: 99999 !important;
                    background: #040c1c !important; 
                    display: flex !important;
                    flex-direction: column !important;
                    gap: 20px !important;
                    padding-bottom: 20px !important;
                    box-sizing: border-box !important;
                }

                /* CUSTOM DASHBOARD CONTAINER (Transparent, just layout) */
                .hs-custom-dashboard {
                    display: flex !important;
                    flex-direction: column !important;
                    height: 100% !important;
                    gap: 20px !important; /* THE GAP */
                    pointer-events: auto !important;
                    background: transparent !important; /* No single box background */
                    box-shadow: none !important;
                    border: none !important;
                }

                /* DISTINCT TECH CARDS */
                .hs-custom-card {
                    flex: 1 !important;
                    display: flex !important;
                    flex-direction: column !important;
                    background: rgba(12, 24, 45, 0.95) !important; /* Deep Blue Background */
                    border: 1px solid rgba(0, 180, 255, 0.3) !important; /* Tech Border */
                    box-shadow: inset 0 0 15px rgba(0, 180, 255, 0.1), 0 0 10px rgba(0,0,0,0.5) !important;
                    position: relative;
                    overflow: hidden !important;
                }

                /* CYAN BRACKET ACCENTS (Tech Feel) */
                .hs-custom-card::before, .hs-custom-card::after {
                    content: '';
                    position: absolute;
                    width: 10px;
                    height: 10px;
                    border: 2px solid #00d2ff;
                    transition: all 0.3s;
                    z-index: 2;
                }
                .hs-custom-card::before {
                    top: -1px; left: -1px;
                    border-right: none; border-bottom: none;
                }
                .hs-custom-card::after {
                    bottom: -1px; right: -1px;
                    border-left: none; border-top: none;
                }

                /* CUSTOM HEADER */
                .hs-custom-header {
                    padding: 0 15px !important;
                    font-size: 15px !important;
                    font-weight: 600 !important;
                    color: #fff !important;
                    background: rgba(0, 150, 255, 0.1) !important;
                    border-bottom: 1px solid rgba(0, 200, 255, 0.2) !important;
                    display: flex;
                    align-items: center;
                    height: 40px !important;
                    flex-shrink: 0;
                }
                .hs-custom-header::before {
                    content: '';
                    display: inline-block;
                    width: 4px;
                    height: 16px;
                    background: #00d2ff;
                    margin-right: 12px;
                    box-shadow: 0 0 8px #00d2ff;
                }

                /* CUSTOM BODY */
                .hs-custom-body {
                    flex: 1 !important;
                    overflow-y: auto !important;
                    padding: 10px 15px !important;
                    scrollbar-width: thin;
                    scrollbar-color: #2c5282 #0a1929;
                }

                /* STATUS HIDDEN (User didn't ask for it in V13, cleaning up to match screenshots) */
                .hs-cloud-status-brief { display: none !important; }
                /* V7 XPATH HUNTER STYLES */
                
                /* Target Discovered Column via ID */
                #hs-target-column {
                    display: flex !important;
                    flex-direction: column !important;
                    height: calc(100vh - 120px) !important;
                    min-height: 0 !important;
                    background: transparent !important;
                }

                /* HIDE ALL ORIGINAL REACT CHILDREN */
                #hs-target-column > *:not(.hs-custom-dashboard) {
                    display: none !important;
                    visibility: hidden !important;
                    height: 0 !important;
                    overflow: hidden !important;
                }
            `;
            document.head.appendChild(style);
        };

        // 3. Map Intelligence Injector (Right-side boxes)
        let cachedThreatData = null;

        const injectCloudIntelligence = async () => {
            try {
                // V19: VIOLET CRASH FIX & DEFENSIVE CODING

                // 1. DIAGNOSTICS DOT
                let dot = document.getElementById('hs-status-dot');
                if (!dot) {
                    dot = document.createElement('div');
                    dot.id = 'hs-status-dot';
                    dot.style.cssText = "position:fixed; top:5px; right:5px; width:8px; height:8px; background:red; border-radius:50%; z-index:99999; pointer-events:none; box-shadow:0 0 5px red;";
                    document.body.appendChild(dot);
                }
                const setDot = (color) => {
                    dot.style.background = color;
                    dot.style.boxShadow = `0 0 5px ${color}`;
                };

                // 2. PATH CHECK
                if (!(location.pathname.includes('/index') || location.hash.includes('index'))) {
                    dot.style.display = 'none';
                    return;
                }
                dot.style.display = 'block';

                // 3. DEFENSIVE HELPER (Prevent Crash)
                const getTsSignature = () => {
                    return Math.floor(Date.now() / 2000).toString(); // Update every 2s
                };

                // 4. FETCH DATA
                const fetchThreatDataLocal = async () => {
                    if (typeof window.getThreatData === 'function') {
                        try {
                            const d = await window.getThreatData();
                            if (d && (d.hackers || d.cs)) return d;
                        } catch (e) { }
                    }
                    try {
                        const r = await fetch('/assets/live_threats.json');
                        if (r.ok) return await r.json();
                    } catch (e) { }
                    return null;
                };

                if (!cachedThreatData || (Date.now() - (cachedThreatData.timestamp || 0) > 10000)) {
                    cachedThreatData = await fetchThreatDataLocal();
                    if (cachedThreatData) cachedThreatData.timestamp = Date.Now();
                }
                const threatData = cachedThreatData;
                if (!threatData) {
                    setDot('orange'); // Data fetch warning
                    return;
                }

                // Helper: Generate HTML Rows
                const generateRows = (items, type) => {
                    // Safety check for items
                    if (!Array.isArray(items)) return '';
                    return items.map(item => {
                        if (type === 'hacker') {
                            return `<div style="display:flex; justify-content:space-between; margin-bottom:8px; font-size:13px; border-bottom:1px solid rgba(0, 210, 255, 0.1); padding-bottom:6px;">
                                        <span style="color:#ff4d4f; font-weight:bold; width: 100px;">${item.ip}</span>
                                        <span style="color:#94a3b8; flex:1; text-align:right; margin-right:10px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${item.location}</span>
                                        <span style="color:#4a5568; width: 60px; text-align:right;">${item.time.split(' ')[1] || item.time}</span>
                                    </div>`;
                        } else {
                            return `<div style="display:flex; justify-content:space-between; margin-bottom:8px; font-size:13px; border-bottom:1px solid rgba(0, 210, 255, 0.1); padding-bottom:6px;">
                                        <span style="color:#faad14; font-weight:bold; width: 100px;">${item.ip}</span>
                                        <span style="color:#94a3b8; flex:1; text-align:right; margin-right:10px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${item.type}</span>
                                        <span style="color:#faad14; background:rgba(250,173,20,0.1); padding:0 6px; border-radius:2px; font-size:11px;">${item.risk}</span>
                                    </div>`;
                        }
                    }).join('');
                };

                const injectIntoContainer = (container, data, type) => {
                    const currentSig = getTsSignature();
                    if (container.dataset.ver === currentSig) return; // Already updated

                    container.innerHTML = `
                        <div style="height:100%; overflow-y:auto; padding:10px; scrollbar-width:thin;">
                            ${generateRows(data, type)}
                        </div>
                    `;
                    container.dataset.ver = currentSig;
                    container.style.textAlign = 'left';
                    container.style.display = 'block';
                };

                // STRATEGY A: FUZZY "NO DATA" HUNTER
                let success = false;
                try {
                    // Search for any element with text roughly matching "specific reasons"
                    // This covers "Trying to identify specific reasons", case variations, etc.
                    const allElements = Array.from(document.querySelectorAll('span, div, p'));
                    const emptyStateNodes = allElements.filter(el => {
                        const txt = (el.innerText || "").toLowerCase();
                        return txt.includes('specific reasons');
                    });

                    if (emptyStateNodes.length >= 2) {
                        // Assume 0=Top, 1=Bottom. 
                        const getBodyContainer = (node) => {
                            let parent = node.parentElement;
                            // Walk up max 5 levels or until body/card
                            for (let i = 0; i < 5; i++) {
                                if (!parent || parent.tagName === 'BODY' || parent.classList.contains('el-card__body')) break;
                                if (parent.clientHeight > 50) return parent; // Good candidate
                                parent = parent.parentElement;
                            }
                            return parent || node.parentElement;
                        };

                        const hackersContainer = getBodyContainer(emptyStateNodes[0]);
                        const csContainer = getBodyContainer(emptyStateNodes[1]);

                        if (hackersContainer && csContainer) {
                            injectIntoContainer(hackersContainer, (threatData.hackers || []).slice(0, 20), 'hacker');
                            injectIntoContainer(csContainer, (threatData.cs || []).slice(0, 20), 'cs');
                            success = true;
                        }
                    }
                } catch (errA) {
                    console.error("Strategy A Fail", errA);
                }

                // STRATEGY B: HEADER HUNTER (Fallback)
                if (!success) {
                    try {
                        // Try to find by Header Text "Recent active hackers"
                        const injectByHeader = (headerText, data, type) => {
                            const headers = Array.from(document.querySelectorAll('div, span, h4, h5, .title'));
                            const header = headers.find(el => el.innerText && el.innerText.includes(headerText));
                            if (!header) return false;

                            const card = header.closest('[class*="card"]') || header.parentElement?.parentElement;
                            if (!card) return false;

                            let body = Array.from(card.children).find(child => child !== header && child !== header.parentElement && child.tagName === 'DIV');
                            if (!body) body = card.querySelector('.el-card__body') || card.lastElementChild;

                            if (body) {
                                injectIntoContainer(body, data, type);
                                return true;
                            }
                            return false;
                        };
                        const hSuccess = injectByHeader('Recent active hackers', (threatData.hackers || []).slice(0, 20), 'hacker');
                        const cSuccess = injectByHeader('suspicious CS', (threatData.cs || []).slice(0, 20), 'cs');
                        if (hSuccess || cSuccess) success = true;
                    } catch (errB) {
                        console.error("Strategy B Fail", errB);
                    }
                }

                // STATUS UPDATE
                setDot(success ? '#00d2ff' : 'red'); // Blue = Success, Red = Fail

            } catch (e) {
                console.error("[HoneyScan] Injection Error:", e);
                const dot = document.getElementById('hs-status-dot');
                if (dot) dot.style.background = 'purple'; // Purple = Crash
            }
        };

        // 4. AGGRESSIVE LOOP (The "Enforcer")
        let frameCount = 0;
        const persistenceLoop = () => {
            frameCount++;
            const now = performance.now();

            // Run checks throttled
            if (now < 60000 || frameCount % 20 === 0) {
                if (location.href.includes('/dashboard')) injectDashboardThreats();
                if (location.href.includes('/index')) injectCloudIntelligence();
            }
            requestAnimationFrame(persistenceLoop);
        };

        // V14 HARD KILL: Global Event Interceptors for SPA Navigation
        (function () {
            // 1. Click Interceptor (Immediate "Close" reaction)
            window.addEventListener('click', (e) => {
                const target = e.target;
                const text = target.innerText || "";

                // Heuristic: If user clicks "Close", "Back", or "Dashboard" (in menu)
                if (text.includes('Close') || text.includes('Setting') || target.closest('.el-menu-item')) {
                    const overlay = document.getElementById('hs-fixed-overlay');
                    if (overlay) overlay.style.display = 'none';
                }
            }, true);

            // 2. History API Patch
            const patchHistory = (method) => {
                const original = history[method];
                return function (...args) {
                    const result = original.apply(this, args);
                    const overlay = document.getElementById('hs-fixed-overlay');
                    if (overlay && (!location.href.includes('/index') && !location.hash.includes('index'))) {
                        overlay.style.display = 'none';
                    }
                    return result;
                };
            };
            history.pushState = patchHistory('pushState');
            history.replaceState = patchHistory('replaceState');

            // 3. Navigation Events
            window.addEventListener('popstate', () => {
                const overlay = document.getElementById('hs-fixed-overlay');
                if (overlay) overlay.style.display = 'none';
            });
            window.addEventListener('hashchange', () => {
                const overlay = document.getElementById('hs-fixed-overlay');
                if (overlay) overlay.style.display = 'none';
            });

            // Start the polling loop
            requestAnimationFrame(persistenceLoop);
        })();

        console.log("[HoneyScan] Resilient Intelligence Layer V9 (Enforcer) Active");
    </script>
</body>

```