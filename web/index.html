<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>lemueIO SecMonitor</title>
    <link rel="icon" type="image/x-icon" href="assets/favicon.ico">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <style>
        body {
            background-color: #0f172a;
            color: #f8fafc;
            overflow: hidden;
            font-family: 'Inter', sans-serif;
        }

        .glass {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .map-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        .overlay {
            position: absolute;
            z-index: 10;
            pointer-events: none;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
        }

        .pointer-events-auto {
            pointer-events: auto;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 4px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 2px;
        }

        /* Ticker Animation */
        @keyframes ticker {
            0% {
                transform: translateX(100%);
            }

            100% {
                transform: translateX(-100%);
            }
        }

        .ticker-wrap {
            overflow: hidden;
            white-space: nowrap;
        }

        .ticker-move {
            display: inline-block;
            animation: ticker 30s linear infinite;
        }

        .ticker-item {
            display: inline-block;
            padding: 0 2rem;
        }
    </style>
</head>

<body>

    <!-- Map Background -->
    <div id="map" class="map-container"></div>

    <!-- UI Overlay -->
    <div class="overlay flex flex-col justify-between p-4">

        <!-- Header -->
        <div class="flex justify-between items-start pointer-events-auto">
            <div class="glass rounded-xl p-4 flex items-center gap-4">
                <img src="assets/logo_bear.png" class="h-12 w-12 object-contain" alt="Logo">
                <div>
                    <h1 class="text-xl font-bold text-green-400 tracking-wider">HONEY SCAN</h1>
                    <p class="text-xs text-slate-400 uppercase tracking-widest">Active Defense Platform</p>
                </div>
            </div>

            <!-- Stats Panel -->
            <div class="flex gap-4">
                <div class="glass rounded-xl p-3 w-40 text-center">
                    <p class="text-xs text-slate-400 uppercase">Total Attacks</p>
                    <p id="stat-total" class="text-2xl font-mono font-bold text-white">Loading...</p>
                </div>
                <div class="glass rounded-xl p-3 w-40 text-center">
                    <p class="text-xs text-slate-400 uppercase">Today</p>
                    <p id="stat-today" class="text-2xl font-mono font-bold text-red-400">Loading...</p>
                </div>
                <div class="glass rounded-xl p-3 w-40 text-center">
                    <p class="text-xs text-slate-400 uppercase">Top Source</p>
                    <div class="flex items-center justify-center gap-2 mt-1">
                        <svg class="w-6 h-4" id="stat-flag-svg">
                            <use id="stat-flag-use" href=""></use>
                        </svg>
                        <p id="stat-top" class="text-lg font-bold text-yellow-400">...</p>
                    </div>
                </div>
            </div>

            <!-- Link Bar -->
            <div class="glass rounded-xl p-2 flex gap-3">
                <a href="https://github.com/derlemue/honey-scan" target="_blank"
                    class="text-slate-400 hover:text-green-400 transition"><svg class="w-6 h-6" fill="currentColor"
                        viewBox="0 0 24 24">
                        <path
                            d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z" />
                    </svg></a>
                <a href="https://feed.sec.lemue.org/" target="_blank"
                    class="text-slate-400 hover:text-green-400 transition"><svg class="w-6 h-6" fill="currentColor"
                        viewBox="0 0 24 24">
                        <path
                            d="M4 4.44A15.56 15.56 0 0 1 19.56 20h-2.83A12.73 12.73 0 0 0 4 7.27V4.44m0 5.66a9.9 9.9 0 0 1 9.9 9.9h-2.83A7.07 7.07 0 0 0 4 12.93V10.1z" />
                    </svg></a>
            </div>
        </div>

        <!-- Main Content (Columns) -->
        <div class="flex-1 flex gap-4 mt-4 overflow-hidden pointer-events-none">
            <!-- Left: Empty for Map Visibility -->
            <div class="flex-1"></div>

            <!-- Right: Live Feed -->
            <div class="w-96 glass rounded-xl flex flex-col overflow-hidden pointer-events-auto">
                <div class="p-3 border-b border-slate-700 bg-slate-800/50">
                    <h2 class="text-sm font-bold text-green-400">Live Active Threats</h2>
                </div>
                <div id="hacker-list" class="flex-1 overflow-y-auto p-2 space-y-2">
                    <!-- Dynamic Content -->
                    <div class="text-center text-slate-500 py-10">Connecting to feed...</div>
                </div>
                <div class="p-3 border-t border-slate-700 bg-slate-800/50">
                    <h2 class="text-sm font-bold text-orange-400">Suspicious Scanners</h2>
                </div>
                <div id="scanner-list" class="h-1/3 overflow-y-auto p-2 space-y-2 border-t border-slate-700">
                    <!-- Dynamic Content -->
                </div>
            </div>
        </div>

        <!-- Footer / Ticker -->
        <div class="mt-4 pointer-events-auto">
            <div class="glass rounded-xl p-2 flex items-center overflow-hidden">
                <div class="bg-red-500/20 text-red-400 px-3 py-1 rounded text-xs font-bold mr-4 animate-pulse">LIVE
                </div>
                <div class="ticker-wrap flex-1">
                    <div id="ticker-content" class="ticker-move">
                        <!-- Dynamic Ticker Items -->
                    </div>
                </div>
                <div id="clock" class="ml-4 font-mono text-xs text-slate-400 w-32 text-right">00:00:00</div>
            </div>
        </div>
    </div>

    <script src="assets/country_map.js"></script>
    <script>
        // --- Configuration ---
        const DEFAULT_LOCATION = [51.1657, 10.4515]; // Germany
        const DEFAULT_ZOOM = 5;

        // --- Map Initialization ---
        const map = L.map('map', {
            zoomControl: false,
            attributionControl: false,
            zoomSnap: 0.1
        }).setView(DEFAULT_LOCATION, DEFAULT_ZOOM);

        // Dark Matter Tile Layer (CartoDB)
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            maxZoom: 19
        }).addTo(map);

        // Icon Definitions
        const nodeIcon = L.divIcon({
            className: 'custom-div-icon',
            html: "<div style='background-color:#4ade80; width: 12px; height: 12px; border-radius: 50%; box-shadow: 0 0 10px #4ade80;'></div>",
            iconSize: [12, 12],
            iconAnchor: [6, 6]
        });

        const attackIcon = L.divIcon({
            className: 'custom-div-icon',
            html: "<div style='background-color:#ef4444; width: 8px; height: 8px; border-radius: 50%; box-shadow: 0 0 8px #ef4444; animation: ping 1s cubic-bezier(0, 0, 0.2, 1) infinite;'></div>",
            iconSize: [8, 8],
            iconAnchor: [4, 4]
        });

        let markers = [];

        // --- Data Fetching ---

        const getFlagUrl = (countryName) => {
            if (!countryName) return '';
            let code = 'unknown';
            if (window.COUNTRY_MAP) {
                if (window.COUNTRY_MAP[countryName]) {
                    code = window.COUNTRY_MAP[countryName];
                } else {
                    const found = Object.keys(window.COUNTRY_MAP).find(k => k.toLowerCase() === countryName.toLowerCase() || countryName.includes(k));
                    if (found) code = window.COUNTRY_MAP[found];
                }
            }
            return `assets/symbol-defs.svg#icon-${code}`;
        };

        const updateData = async () => {
            try {
                // 1. Live Threats
                const threatResp = await fetch('assets/live_threats.json?t=' + Date.now());
                const threatData = await threatResp.json();

                renderHackers(threatData.hackers);
                renderScanners(threatData.cs);
                renderTicker(threatData.hackers);

                // 2. Stats
                const statsResp = await fetch('assets/stats.json?t=' + Date.now());
                const statsData = await statsResp.json();

                document.getElementById('stat-total').innerText = statsData.total_attacks.toLocaleString();
                document.getElementById('stat-today').innerText = statsData.today_attacks.toLocaleString();
                document.getElementById('stat-top').innerText = statsData.top_country;

                const flagUrl = getFlagUrl(statsData.top_country);
                document.getElementById('stat-flag-use').setAttribute('href', flagUrl);

                // 3. Location (Self Node)
                // Only run once or less frequently
                if (!window.nodeSet) {
                    const locResp = await fetch('assets/location.json');
                    const locData = await locResp.json();
                    if (locData.lat && locData.lng) {
                        L.marker([locData.lat, locData.lng], { icon: nodeIcon }).addTo(map)
                            .bindPopup(`<b>Node: ${locData.city}</b><br>${locData.ip}`);
                        map.flyTo([locData.lat, locData.lng], 6);
                        window.nodeSet = true;
                    }
                }

            } catch (e) { console.error("Update failed", e); }
        };

        const renderHackers = (list) => {
            const container = document.getElementById('hacker-list');
            container.innerHTML = list.map(item => `
                <div class="flex items-center bg-slate-800/80 p-2 rounded border-l-2 border-red-500 hover:bg-slate-700 transition">
                    <div class="w-8 flex-shrink-0">
                         <svg class="w-6 h-4"><use href="${getFlagUrl(item.location)}"></use></svg>
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="flex justify-between">
                            <span class="font-mono text-sm text-white truncate">${item.ip}</span>
                            <span class="text-xs text-green-400 font-bold">${item.count} hits</span>
                        </div>
                        <div class="text-xs text-slate-400 capitalize">${item.location}</div>
                    </div>
                </div>
            `).join('');
        };

        const renderScanners = (list) => {
            const container = document.getElementById('scanner-list');
            container.innerHTML = list.map(item => `
                <div class="flex items-center bg-slate-800/50 p-2 rounded text-xs">
                     <div class="w-2 h-2 rounded-full mr-2 ${item.risk === 'Critical' ? 'bg-red-500' : 'bg-orange-400'}"></div>
                     <span class="font-mono text-slate-300 flex-1">${item.ip}</span>
                     <span class="text-slate-500">${item.type}</span>
                </div>
            `).join('');
        };

        const renderTicker = (list) => {
            const container = document.getElementById('ticker-content');
            // Duplicate list for seamless loop
            const items = [...list, ...list, ...list].map(item => `
                <div class="ticker-item">
                    <span class="text-slate-400 mr-2">Attack from</span>
                    <span class="font-bold text-red-400 flex items-center gap-2">
                        <svg class="w-4 h-3 inline-block"><use href="${getFlagUrl(item.location)}"></use></svg>
                        ${item.location}
                    </span>
                    <span class="text-slate-600 mx-2">via</span>
                    <span class="font-mono text-slate-300">${item.ip}</span>
                </div>
            `).join('');
            container.innerHTML = items;
        };

        // --- Clock ---
        setInterval(() => {
            const now = new Date();
            document.getElementById('clock').innerText = now.toLocaleTimeString();
        }, 1000);

        // --- Initial Load ---
        updateData();
        setInterval(updateData, 5000);

    </script>
</body>

</html>